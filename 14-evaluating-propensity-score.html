<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Evaluating your propensity score model</title>
    <meta charset="utf-8" />
    <meta name="author" content="Lucy D’Agostino McGowan" />
    <meta name="date" content="2022-03-26" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/tile-view-0.2.6/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view-0.2.6/tile-view.js"></script>
    <link href="libs/countdown-0.3.5/countdown.css" rel="stylesheet" />
    <script src="libs/countdown-0.3.5/countdown.js"></script>
    <link rel="stylesheet" href="css/style.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">







class: center middle main-title section-title-1

# Evaluating your propensity score model

.class-info[

**Session 14**

.light[STA 379/679: Causal Inference &lt;br&gt;
Lucy D'Agostino McGowan
]

]

---
class: title title-1

# Checking balance

.box-1.medium[Love Plots]

--

.box-1.medium[eCDF plots]

---
class: title title-1

# Standardized Mean Difference (SMD)

`$$\LARGE d = \frac{\bar{z}_{exposed}-\bar{z}_{unexposed}}{\sqrt{\frac{s^2_{exposed}+s^2_{unexposed}}{2}}}$$`
--
&lt;br&gt;
.box-1[Rule of thumb: SMD &lt; 0.1]
---

class: title title-1

# Customer satisfaction data



.small[

```r
library(tidyverse)
library(broom)

glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + previous_spend, 
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]

---

class: title title-1

# Customer satisfaction data

.small[

```r
library(tidyverse)
library(broom)

glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + previous_spend, 
        family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]

.box-1[Which confounders did I identify?]

---

class: title title-1

# Customer satisfaction data

.small[

```r
library(tidyverse)
library(broom)

*glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age +
*     education + gender + former_customer_service + previous_spend,
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]
---

class: title title-1

# Customer satisfaction data

.small[

```r
library(tidyverse)
library(broom)

glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + previous_spend, 
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]

.box-1[What estimand am I interested in?]
---
class: title title-1
# Customer satisfaction data

.small[

```r
library(tidyverse)
library(broom)

glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + previous_spend, 
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
* mutate(atm_wts = pmin(.fitted, 1 - .fitted) /
*          (satisfied_customer_service * .fitted +
*             (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]

.box-1[What estimand am I interested in?]
---

class: title title-1

# SMD in R


```r
library(smd)
library(tidyverse)
df %&gt;% 
  # w is optional
  summarise(smd = smd(confounder_1, 
                      exposure, 
                      w = wts)$estimate)
```

---
class: title title-1

# SMD in R

.small[

```r
library(smd)
library(tidyverse)
customer_satisfaction %&gt;% 
  # w is optional
  summarize(smd = smd(income, 
                      satisfied_customer_service, 
                      w = atm_wts)$estimate)
```

```
## # A tibble: 1 × 1
##      smd
##    &lt;dbl&gt;
## 1 0.0297
```
]


---

class: title title-1

# SMD in R


```r
smds &lt;- df %&gt;% 
  summarise( 
    across( 
      c(confounder_1, confounder_2, ...), 
      list(
        unweighted = ~smd(.x, exposure)$estimate, 
        weighted = ~smd(.x, exposure, wts)$estimate 
      )
    )
  )
```
---

class: title title-1

# SMD in R


```r
smds &lt;- df %&gt;% 
  summarise( 
    across( 
*     c(confounder_1, confounder_2, ...),
      list(
        unweighted = ~smd(.x, exposure)$estimate, 
        weighted = ~smd(.x, exposure, wts)$estimate 
      )
    )
  )
```

---

class: title title-1

# SMD in R


```r
smds &lt;- df %&gt;% 
  summarise( 
    across( 
      c(confounder_1, confounder_2, ...), 
      list(
*       unweighted = ~smd(.x, exposure)$estimate,
*       weighted = ~smd(.x, exposure, wts)$estimate
      )
    )
  )
```

---

class: title title-1

# SMD in R

.small[

```r
smds &lt;- customer_satisfaction %&gt;% 
  summarise( 
    across( 
      c(income, married, n_kids, has_pets, age, 
        education, gender, former_customer_service, previous_spend), 
      list(
        unweighted = ~smd(.x, satisfied_customer_service)$estimate, 
        weighted = ~smd(.x, satisfied_customer_service, atm_wts)$estimate 
      )
    )
  )
```
]

---

class: title title-1

# <svg aria-hidden="true" role="img" viewBox="0 0 640 512" style="height:1em;width:1.25em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M624 416H381.54c-.74 19.81-14.71 32-32.74 32H288c-18.69 0-33.02-17.47-32.77-32H16c-8.8 0-16 7.2-16 16v16c0 35.2 28.8 64 64 64h512c35.2 0 64-28.8 64-64v-16c0-8.8-7.2-16-16-16zM576 48c0-26.4-21.6-48-48-48H112C85.6 0 64 21.6 64 48v336h512V48zm-64 272H128V64h384v256z"/></svg> Application Exercise

.box-1[Go to our Github organization and open `appex-10`]

.box-1[Fit a propensity score model for `satisfied_customer_service` (you can use the one you chose for Lab 2)]

.box-1[Calculate the `ate` and `ato` weights]

.box-1[Calculate the standardized mean differences (unweighted, `ate` weighted and `ato` weighted) for all of the variables (excluding the outcome, `next_spend`)]

.box-1[Knit, commit, push to GitHub]

<div class="countdown" id="timer_623faafa" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>
---

class: title title-1

# SMD in R

.small[

```r
smds
```

```
## # A tibble: 1 × 18
##   income_unweighted income_weighted married_unweighted married_weighted
##               &lt;dbl&gt;           &lt;dbl&gt;              &lt;dbl&gt;            &lt;dbl&gt;
## 1            0.0168          0.0297             0.0357           0.0350
## # … with 14 more variables: n_kids_unweighted &lt;dbl&gt;, n_kids_weighted &lt;dbl&gt;,
## #   has_pets_unweighted &lt;dbl&gt;, has_pets_weighted &lt;dbl&gt;, age_unweighted &lt;dbl&gt;,
## #   age_weighted &lt;dbl&gt;, education_unweighted &lt;dbl&gt;, education_weighted &lt;dbl&gt;,
## #   gender_unweighted &lt;dbl&gt;, gender_weighted &lt;dbl&gt;,
## #   former_customer_service_unweighted &lt;dbl&gt;,
## #   former_customer_service_weighted &lt;dbl&gt;, previous_spend_unweighted &lt;dbl&gt;,
## #   previous_spend_weighted &lt;dbl&gt;
```
]

---

class: title title-1

# SMD in R


```r
plot_df &lt;- smds %&gt;% 
  pivot_longer( 
    everything(),
    values_to = "SMD", 
    names_to = c("variable", "Method"), 
    names_pattern = "(.*)_(.*)"
  )
```

---

class: title title-1

# SMD in R


```r
plot_df &lt;- smds %&gt;% 
* pivot_longer(
    everything(),
    values_to = "SMD", 
    names_to = c("variable", "Method"), 
    names_pattern = "(.*)_(.*)"
  )
```

---

class: title title-1

# SMD in R


```r
plot_df &lt;- smds %&gt;% 
  pivot_longer( 
*   everything(),
    values_to = "SMD", 
    names_to = c("variable", "Method"), 
    names_pattern = "(.*)_(.*)"
  )
```

---

class: title title-1

# SMD in R


```r
plot_df &lt;- smds %&gt;% 
  pivot_longer( 
    everything(),
*   values_to = "SMD",
    names_to = c("variable", "Method"), 
    names_pattern = "(.*)_(.*)"
  )
```

---
class: title title-1

# SMD in R


```r
plot_df &lt;- smds %&gt;% 
  pivot_longer( 
    everything(),
    values_to = "SMD", 
*   names_to = c("variable", "Method"),
*   names_pattern = "(.*)_(.*)"
  )
```

---
class: title title-1

# SMD in R


```r
plot_df &lt;- smds %&gt;% 
  pivot_longer( 
    everything(),
    values_to = "SMD", 
    names_to = c("variable", "Method"),
    names_pattern = "(.*)_(.*)"
  ) %&gt;%
  arrange(Method, abs(SMD)) %&gt;%
  mutate(variable = fct_inorder(variable))
```


---

class: title title-1

# SMD in R

.small[

```r
plot_df
```

```
## # A tibble: 18 × 3
##    variable                Method             SMD
##    &lt;fct&gt;                   &lt;chr&gt;            &lt;dbl&gt;
##  1 gender                  unweighted  0.0161    
##  2 income                  unweighted  0.0168    
##  3 has_pets                unweighted -0.0285    
##  4 married                 unweighted  0.0357    
##  5 former_customer_service unweighted  0.0616    
##  6 n_kids                  unweighted -0.203     
##  7 age                     unweighted  0.340     
##  8 education               unweighted -0.664     
##  9 previous_spend          unweighted -1.02      
## 10 education               weighted    0.00000476
## 11 former_customer_service weighted    0.00869   
## 12 previous_spend          weighted    0.0138    
## 13 gender                  weighted    0.0148    
## 14 age                     weighted    0.0194    
## 15 has_pets                weighted    0.0221    
## 16 n_kids                  weighted    0.0226    
## 17 income                  weighted    0.0297    
## 18 married                 weighted    0.0350
```
]

---

class: title title-1

# Love Plot

.left-code[

```r
ggplot(
  data = plot_df,
  aes(x = abs(SMD), y = variable, 
      group = Method, color = Method)
) +  
  geom_line(orientation = "y") +
  geom_point() + 
  geom_vline(xintercept = 0.1, 
             color = "black", size = 0.1)
```
]

---

class: title title-1

# Love Plot

.left-code[

```r
ggplot(
  data = plot_df,
* aes(x = abs(SMD), y = variable,
*     group = Method, color = Method)
) +  
  geom_line(orientation = "y") +
  geom_point() + 
  geom_vline(xintercept = 0.1, 
             color = "black", size = 0.1)
```
]

---

class: title title-1

# Love Plot

.left-code[

```r
ggplot(
  data = plot_df,
  aes(x = abs(SMD), y = variable, 
      group = Method, color = Method)
) +  
* geom_line(orientation = "y") +
  geom_point() + 
  geom_vline(xintercept = 0.1, 
             color = "black", size = 0.1)
```
]

---

class: title title-1

# Love Plot

.left-code[

```r
ggplot(
  data = plot_df,
  aes(x = abs(SMD), y = variable, 
      group = Method, color = Method)
) +  
  geom_line(orientation = "y") +
* geom_point() +
  geom_vline(xintercept = 0.1, 
             color = "black", size = 0.1)
```
]

---

class: title title-1

# Love Plot

.left-code[

```r
ggplot(
  data = plot_df,
  aes(x = abs(SMD), y = variable, 
      group = Method, color = Method)
) +  
  geom_line(orientation = "y") +
  geom_point() + 
* geom_vline(xintercept = 0.1,
*            color = "black", size = 0.1)
```
]

---

class: title title-1

# Love Plot

.left-code[

```r
ggplot(
  data = plot_df,
  aes(x = abs(SMD), y = variable, 
      group = Method, color = Method)
) +  
  geom_line(orientation = "y") +
  geom_point() + 
  geom_vline(xintercept = 0.1,  
             color = "black", size = 0.1) 
```

]

.right-plot[

&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-27-1.png" width="504" style="display: block; margin: auto;" /&gt;

]
---
class: title title-1

# <svg aria-hidden="true" role="img" viewBox="0 0 640 512" style="height:1em;width:1.25em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M624 416H381.54c-.74 19.81-14.71 32-32.74 32H288c-18.69 0-33.02-17.47-32.77-32H16c-8.8 0-16 7.2-16 16v16c0 35.2 28.8 64 64 64h512c35.2 0 64-28.8 64-64v-16c0-8.8-7.2-16-16-16zM576 48c0-26.4-21.6-48-48-48H112C85.6 0 64 21.6 64 48v336h512V48zm-64 272H128V64h384v256z"/></svg> Application Exercise

.box-1[Pivot your standardized mean difference output to make it plot-able]

.box-1[Arrange your data frame by method and (absolute) standardized mean difference]

.box-1[Create a Love Plot of your standardized mean differences]

.box-1[Knit, commit, push to GitHub]

<div class="countdown" id="timer_623faaed" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---


class: title title-1

# Compare Matching

.small[

```r
library(MatchIt)
matched_smds &lt;- matchit(satisfied_customer_service ~ income + married +  
                          n_kids + has_pets + age + education + gender + 
                          former_customer_service + previous_spend, 
                        data = customer_satisfaction, caliper = 0.5) %&gt;%
  get_matches() %&gt;%
  summarise( 
    across( 
      c(income, married, n_kids, has_pets, age, 
        education, gender, former_customer_service, previous_spend), 
      list(
        matched = ~smd(.x, satisfied_customer_service)$estimate
      )
    )
  )
```
]
---

class: title title-1

# Compare Matching

.small[

```r
*library(MatchIt)
matched_smds &lt;- matchit(satisfied_customer_service ~ income + married +  
                          n_kids + has_pets + age + education + gender + 
                          former_customer_service + previous_spend, 
                        data = customer_satisfaction, caliper = 0.5) %&gt;%
  get_matches() %&gt;%
  summarise( 
    across( 
      c(income, married, n_kids, has_pets, age, 
        education, gender, former_customer_service, previous_spend), 
      list(
        matched = ~smd(.x, satisfied_customer_service)$estimate
      )
    )
  )
```
]

---

class: title title-1

# Compare Matching

.small[

```r
library(MatchIt)
*matched_smds &lt;- matchit(satisfied_customer_service ~ income + married +
*                         n_kids + has_pets + age + education + gender +
*                         former_customer_service + previous_spend,
                        data = customer_satisfaction, caliper = 0.5) %&gt;%
  get_matches() %&gt;%
  summarise( 
    across( 
      c(income, married, n_kids, has_pets, age, 
        education, gender, former_customer_service, previous_spend), 
      list(
        matched = ~smd(.x, satisfied_customer_service)$estimate
      )
    )
  )
```
]

---

class: title title-1

# Compare Matching

.small[

```r
library(MatchIt)
matched_smds &lt;- matchit(satisfied_customer_service ~ income + married +  
                          n_kids + has_pets + age + education + gender + 
                          former_customer_service + previous_spend, 
*                       data = customer_satisfaction, caliper = 0.5) %&gt;%
  get_matches() %&gt;%
  summarise( 
    across( 
      c(income, married, n_kids, has_pets, age, 
        education, gender, former_customer_service, previous_spend), 
      list(
        matched = ~smd(.x, satisfied_customer_service)$estimate
      )
    )
  )
```
]

---

class: title title-1

# Compare Matching

.small[

```r
library(MatchIt)
matched_smds &lt;- matchit(satisfied_customer_service ~ income + married +  
                          n_kids + has_pets + age + education + gender + 
                          former_customer_service + previous_spend, 
                        data = customer_satisfaction, caliper = 0.5) %&gt;%
* get_matches() %&gt;%
  summarise( 
    across( 
      c(income, married, n_kids, has_pets, age, 
        education, gender, former_customer_service, previous_spend), 
      list(
        matched = ~smd(.x, satisfied_customer_service)$estimate
      )
    )
  )
```
]

---

class: title title-1

# Compare Matching

.small[

```r
library(MatchIt)
matched_smds &lt;- matchit(satisfied_customer_service ~ income + married +  
                          n_kids + has_pets + age + education + gender + 
                          former_customer_service + previous_spend, 
                        data = customer_satisfaction, caliper = 0.5) %&gt;%
  get_matches() %&gt;%
* summarise(
*   across(
*     c(income, married, n_kids, has_pets, age,
*       education, gender, former_customer_service, previous_spend),
*     list(
*       matched = ~smd(.x, satisfied_customer_service)$estimate
*     )
*   )
* )
```
]

---

class: title title-1

# Compare Matching

.small[

```r
matched_smds
```

```
##   income_matched married_matched n_kids_matched has_pets_matched age_matched
## 1     0.03624997     0.006514001     -0.1074924       0.04472136   0.1654134
##   education_matched gender_matched former_customer_service_matched
## 1        -0.2177035      0.0959927                      0.02060323
##   previous_spend_matched
## 1             -0.4016459
```
]

---

class: title title-1

# Compare Matching


```r
plot_df_all &lt;- matched_smds %&gt;%
  pivot_longer( 
    everything(),
    values_to = "SMD", 
    names_to = c("variable", "Method"),
    names_pattern = "(.*)_(.*)"
  ) %&gt;%
  bind_rows(plot_df)
```

---

class: title title-1

# Compare Matching


```r
*plot_df_all &lt;- matched_smds %&gt;%
  pivot_longer( 
    everything(),
    values_to = "SMD", 
    names_to = c("variable", "Method"),
    names_pattern = "(.*)_(.*)"
  ) %&gt;%
  bind_rows(plot_df)
```

---

class: title title-1

# Compare Matching


```r
plot_df_all &lt;- matched_smds %&gt;% 
* pivot_longer(
*   everything(),
*   values_to = "SMD",
*   names_to = c("variable", "Method"),
*   names_pattern = "(.*)_(.*)"
  ) %&gt;%
  bind_rows(plot_df)
```

---

class: title title-1

# Compare Matching


```r
plot_df_all &lt;- matched_smds %&gt;% 
  pivot_longer( 
    everything(),
    values_to = "SMD", 
    names_to = c("variable", "Method"),
    names_pattern = "(.*)_(.*)"
  ) %&gt;%
* bind_rows(plot_df)
```

---

class: title title-1

# Compare Matching


```r
plot_df_all &lt;- matched_smds %&gt;% 
  pivot_longer( 
    everything(),
    values_to = "SMD", 
    names_to = c("variable", "Method"),
    names_pattern = "(.*)_(.*)"
  ) %&gt;%
  bind_rows(plot_df) %&gt;%
  arrange(Method, abs(SMD)) %&gt;%
  mutate(variable = fct_inorder(variable))
```

---

class: title title-1

# Love Plot

.left-code[

```r
ggplot(
  data = plot_df_all,
  aes(x = abs(SMD), y = variable, 
      group = Method, color = Method)
) +  
  geom_line(orientation = "y") +
  geom_point() + 
  geom_vline(xintercept = 0.1,  
             color = "black", size = 0.1) 
```
]

.right-plot[
&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-41-1.png" width="504" style="display: block; margin: auto;" /&gt;
]

---

class: title title-1

# What if we changed the caliper?

.small[

```r
matched_smds &lt;- matchit(satisfied_customer_service ~ income + married +  
                          n_kids + has_pets + age + education + gender + 
                          former_customer_service + previous_spend, 
                        data = customer_satisfaction, caliper = 0.01) %&gt;%
  get_matches() %&gt;%
  summarise( 
    across( 
      c(income, married, n_kids, has_pets, age, 
        education, gender, former_customer_service, previous_spend), 
      list(
        matched.calp.01 = ~smd(.x, satisfied_customer_service)$estimate
      )
    )
  )
```
]



---

class: title title-1

# Love Plot

.left-code[

```r
ggplot(
  data = plot_df_all,
  aes(x = abs(SMD), y = variable, 
      group = Method, color = Method)
) +  
  geom_line(orientation = "y") +
  geom_point() + 
  geom_vline(xintercept = 0.1,  
             color = "black", size = 0.1) 
```
]

.right-plot[
&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-45-1.png" width="504" style="display: block; margin: auto;" /&gt;
]

---
class: title title-1

# ECDF

For continuous variables, it can be helpful to look at the _whole_ distribution pre and post-weighting rather than a single summary measure

&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-46-1.png" width="504" style="display: block; margin: auto;" /&gt;

---

class: title title-1

# Unweighted ECDF

.small[

```r
ggplot(customer_satisfaction, 
       aes(x = previous_spend, group = satisfied_customer_service, 
           color = factor(satisfied_customer_service))) +
  stat_ecdf() +
  scale_color_manual("Satisfied with Customer Service", 
                     values = c("#5154B8", "#5DB854"),
                     labels = c("No", "Yes")) + 
  scale_x_continuous("Previous spending", label = scales::dollar) + 
  ylab("Proportion &lt;= x") 
```
]

---

class: title title-1

# Unweighted ECDF

.small[

```r
*ggplot(customer_satisfaction,
*      aes(x = previous_spend, group = satisfied_customer_service,
*          color = factor(satisfied_customer_service))) +
  stat_ecdf() +
  scale_color_manual("Satisfied with Customer Service", 
                     values = c("#5154B8", "#5DB854"),
                     labels = c("No", "Yes")) + 
  scale_x_continuous("Previous spending", label = scales::dollar) + 
  ylab("Proportion &lt;= x") 
```
]

---

class: title title-1

# Unweighted ECDF

.small[

```r
ggplot(customer_satisfaction, 
       aes(x = previous_spend, group = satisfied_customer_service, 
           color = factor(satisfied_customer_service))) +
* stat_ecdf() +
  scale_color_manual("Satisfied with Customer Service", 
                     values = c("#5154B8", "#5DB854"),
                     labels = c("No", "Yes")) + 
  scale_x_continuous("Previous spending", label = scales::dollar) + 
  ylab("Proportion &lt;= x") 
```
]

---

class: title title-1

# Unweighted ECDF

.small[

```r
ggplot(customer_satisfaction, 
       aes(x = previous_spend, group = satisfied_customer_service, 
           color = factor(satisfied_customer_service))) +
  stat_ecdf() +
* scale_color_manual("Satisfied with Customer Service",
*                    values = c("#5154B8", "#5DB854"),
*                    labels = c("No", "Yes")) +
  scale_x_continuous("Previous spending", label = scales::dollar) + 
  ylab("Proportion &lt;= x") 
```
]

---

class: title title-1

# Unweighted ECDF

.small[

```r
ggplot(customer_satisfaction, 
       aes(x = previous_spend, group = satisfied_customer_service, 
           color = factor(satisfied_customer_service))) +
  stat_ecdf() +
  scale_color_manual("Satisfied with Customer Service", 
                     values = c("#5154B8", "#5DB854"),
                     labels = c("No", "Yes")) + 
* scale_x_continuous("Previous spending", label = scales::dollar) +
  ylab("Proportion &lt;= x") 
```
]

---

class: title title-1

# Unweighted ECDF

.small[

```r
ggplot(customer_satisfaction, 
       aes(x = previous_spend, group = satisfied_customer_service, 
           color = factor(satisfied_customer_service))) +
  stat_ecdf() +
  scale_color_manual("Satisfied with Customer Service", 
                     values = c("#5154B8", "#5DB854"),
                     labels = c("No", "Yes")) + 
  scale_x_continuous("Previous spending", label = scales::dollar) + 
* ylab("Proportion &lt;= x")
```
]

---

class: title title-1

# <svg aria-hidden="true" role="img" viewBox="0 0 640 512" style="height:1em;width:1.25em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M624 416H381.54c-.74 19.81-14.71 32-32.74 32H288c-18.69 0-33.02-17.47-32.77-32H16c-8.8 0-16 7.2-16 16v16c0 35.2 28.8 64 64 64h512c35.2 0 64-28.8 64-64v-16c0-8.8-7.2-16-16-16zM576 48c0-26.4-21.6-48-48-48H112C85.6 0 64 21.6 64 48v336h512V48zm-64 272H128V64h384v256z"/></svg> Application Exercise

.box-1[Create an unweighted eCDF looking at `age`]

.box-1[Knit, commit, push to GitHub]

<div class="countdown" id="timer_623fa9ac" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">06</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---
class: title title-1

# Weighted  ECDF 

.small[
&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-53-1.png" width="504" style="display: block; margin: auto;" /&gt;
]

---

class: title title-1

# Weighted  ECDF 

.small[

```r
ecdf_1 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 1) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ecdf_0 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 0) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ggplot(ecdf_1, aes(x = previous_spend, y = cum_pct)) +
  geom_line(color = "#5DB854") +
  geom_line(data = ecdf_0, 
            aes(x = previous_spend, y = cum_pct), 
            color = "#5154B8") + 
  xlab("Previous spending") + 
  ylab("Proportion &lt;= x") 
```
]
---

class: title title-1

# Weighted  ECDF 

.small[

```r
ecdf_1 &lt;- customer_satisfaction %&gt;%
* filter(satisfied_customer_service == 1) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ecdf_0 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 0) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ggplot(ecdf_1, aes(x = previous_spend, y = cum_pct)) +
  geom_line(color = "#5DB854") +
  geom_line(data = ecdf_0, 
            aes(x = previous_spend, y = cum_pct), 
            color = "#5154B8") + 
  xlab("Previous spending") + 
  ylab("Proportion &lt;= x") 
```
]

---

class: title title-1

# Weighted  ECDF 

.small[

```r
ecdf_1 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 1) %&gt;%
* arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ecdf_0 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 0) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ggplot(ecdf_1, aes(x = previous_spend, y = cum_pct)) +
  geom_line(color = "#5DB854") +
  geom_line(data = ecdf_0, 
            aes(x = previous_spend, y = cum_pct), 
            color = "#5154B8") + 
  xlab("Previous spending") + 
  ylab("Proportion &lt;= x") 
```
]

---


class: title title-1

# Weighted  ECDF 

.small[

```r
ecdf_1 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 1) %&gt;%
  arrange(previous_spend) %&gt;%
* mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ecdf_0 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 0) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ggplot(ecdf_1, aes(x = previous_spend, y = cum_pct)) +
  geom_line(color = "#5DB854") +
  geom_line(data = ecdf_0, 
            aes(x = previous_spend, y = cum_pct),
            color = "#5154B8") + 
  xlab("Previous spending") + 
  ylab("Proportion &lt;= x") 
```
]
---

class: title title-1

# Weighted  ECDF 
.small[

```r
ecdf_1 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 1) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
*ecdf_0 &lt;- customer_satisfaction %&gt;%
* filter(satisfied_customer_service == 0) %&gt;%
* arrange(previous_spend) %&gt;%
* mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ggplot(ecdf_1, aes(x = previous_spend, y = cum_pct)) +
  geom_line(color = "#5DB854") +
  geom_line(data = ecdf_0,
            aes(x = previous_spend, y = cum_pct), 
            color = "#5154B8") + 
  xlab("Previous spending") + 
  ylab("Proportion &lt;= x") 
```
]
---
class: title title-1

# Weighted  ECDF 
.small[

```r
ecdf_1 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 1) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ecdf_0 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 0) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
*ggplot(ecdf_1, aes(x = previous_spend, y = cum_pct)) +
  geom_line(color = "#5DB854") +
  geom_line(data = ecdf_0, 
            aes(x = previous_spend, y = cum_pct), 
            color = "#5154B8") + 
  xlab("Previous spending") + 
  ylab("Proportion &lt;= x") 
```
]
---

class: title title-1

# Weighted  ECDF 

.small[

```r
ecdf_1 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 1) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ecdf_0 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 0) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ggplot(ecdf_1, aes(x = previous_spend, y = cum_pct)) +
* geom_line(color = "#5DB854") +
  geom_line(data = ecdf_0, 
            aes(x = previous_spend, y = cum_pct), 
            color = "#5154B8") + 
  xlab("Previous spending") + 
  ylab("Proportion &lt;= x") 
```
]
---

class: title title-1

# Weighted  ECDF 

.small[

```r
ecdf_1 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 1) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ecdf_0 &lt;- customer_satisfaction %&gt;%
  filter(satisfied_customer_service == 0) %&gt;%
  arrange(previous_spend) %&gt;%
  mutate(cum_pct = cumsum(atm_wts) / sum(atm_wts))
ggplot(ecdf_1, aes(x = previous_spend, y = cum_pct)) +
  geom_line(color = "#5DB854") +
* geom_line(data = ecdf_0,
*           aes(x = previous_spend, y = cum_pct),
*           color = "#5154B8") +
  xlab("Previous spending") + 
  ylab("Proportion &lt;= x") 
```

]

---

class: title title-1

# <svg aria-hidden="true" role="img" viewBox="0 0 640 512" style="height:1em;width:1.25em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M624 416H381.54c-.74 19.81-14.71 32-32.74 32H288c-18.69 0-33.02-17.47-32.77-32H16c-8.8 0-16 7.2-16 16v16c0 35.2 28.8 64 64 64h512c35.2 0 64-28.8 64-64v-16c0-8.8-7.2-16-16-16zM576 48c0-26.4-21.6-48-48-48H112C85.6 0 64 21.6 64 48v336h512V48zm-64 272H128V64h384v256z"/></svg> Application Exercise

.box-1[Create an weighted eCDF looking at `age` with the `ate` weights]

.box-1[Create an weighted eCDF looking at `age` with the `ato` weights]

.box-1[Knit, commit, push to GitHub]

<div class="countdown" id="timer_623fa9eb" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">06</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

---

class: title title-1

# Iterate on your propensity score model!


.box-1.medium[Decrease your caliper if doing matching]

--

.box-1.medium[Allow for more degrees of freedom for variables that look imbalanced]

--

.box-inv-1.medium[Polynomial terms // splines]



---

class: title title-1

# Iterate on your propensity score model

.box-1[`previous_spend` modeled as a 3rd degree polynomial]

.small[

```r
glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + 
      poly(previous_spend, 3), 
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]

---

class: title title-1

# Iterate on your propensity score model

.box-1[`previous_spend` modeled as a 3rd degree polynomial]

.small[

```r
glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + 
*     poly(previous_spend, 3),
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]
---

class: title title-1

# Iterate on your propensity score model

.box-1.small[`previous_spend` modeled as a 3rd degree polynomial]

&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-64-1.png" width="504" style="display: block; margin: auto;" /&gt;

---

class: title title-1

# Iterate on your propensity score model

.box-1.small[`previous_spend` modeled as a 3rd degree polynomial]

&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-65-1.png" width="504" style="display: block; margin: auto;" /&gt;

---


class: title title-1

# Iterate on your propensity score model

.box-1[`previous_spend` modeled as a natural spline with 3 degrees of freedom]

.small[

```r
glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + 
      splines::ns(previous_spend, 3),
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]
---

class: title title-1

# Iterate on your propensity score model

.box-1.small[`previous_spend` modeled as a natural spline with 3 degrees of freedom]

.small[

```r
glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + 
*     splines::ns(previous_spend, 3),
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]
---

class: title title-1

# Iterate on your propensity score model

.box-1.small[`previous_spend` modeled as a natural spline with 3 degrees of freedom]

&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-68-1.png" width="504" style="display: block; margin: auto;" /&gt;

---

class: title title-1

# Iterate on your propensity score model

.box-1[`previous_spend` modeled as a natural spline with 3 degrees of freedom]

&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-69-1.png" width="504" style="display: block; margin: auto;" /&gt;


---



class: title title-1

# Iterate on your propensity score model

.box-1.small[`previous_spend` modeled as a natural spline with 8 degrees of freedom]

.small[

```r
glm(satisfied_customer_service ~ income + married + n_kids + has_pets + age + 
      education + gender + former_customer_service + 
*     splines::ns(previous_spend, 8),
    family = binomial(),
    data = customer_satisfaction) %&gt;%
  augment(data = customer_satisfaction, type.predict = "response") %&gt;%
  mutate(atm_wts = pmin(.fitted, 1 - .fitted) / 
           (satisfied_customer_service * .fitted + 
              (1 - satisfied_customer_service) * (1 - .fitted))
  ) -&gt; customer_satisfaction
```
]
---

class: title title-1

# Iterate on your propensity score model

.box-1.small[`previous_spend` modeled as a natural spline with 8 degrees of freedom]

&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-71-1.png" width="504" style="display: block; margin: auto;" /&gt;

---

class: title title-1

# Iterate on your propensity score model

.box-1[`previous_spend` modeled as a natural spline with 8 degrees of freedom]

&lt;img src="14-evaluating-propensity-score_files/figure-html/unnamed-chunk-72-1.png" width="504" style="display: block; margin: auto;" /&gt;

---

class: title title-1

# <svg aria-hidden="true" role="img" viewBox="0 0 640 512" style="height:1em;width:1.25em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M624 416H381.54c-.74 19.81-14.71 32-32.74 32H288c-18.69 0-33.02-17.47-32.77-32H16c-8.8 0-16 7.2-16 16v16c0 35.2 28.8 64 64 64h512c35.2 0 64-28.8 64-64v-16c0-8.8-7.2-16-16-16zM576 48c0-26.4-21.6-48-48-48H112C85.6 0 64 21.6 64 48v336h512V48zm-64 272H128V64h384v256z"/></svg> Application Exercise

.box-1[Update your propensity score model to include at least one natural spline]

.box-1[Recreate your Love Plot and eCDF plots to examine how (whether) this impacts your results]

.box-1[Knit, commit, push to GitHub]

<div class="countdown" id="timer_623fabce" style="right:0;bottom:0;" data-warnwhen="0">
<code class="countdown-time"><span class="countdown-digits minutes">10</span><span class="countdown-digits colon">:</span><span class="countdown-digits seconds">00</span></code>
</div>

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:9",
"navigation": {
"scroll": false
}
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
